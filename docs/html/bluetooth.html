

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>bluetooth (BLE) &mdash; open source watch 1.2.0 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="author" title="About these documents" href="about.html" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="copyright" title="Copyright" href="copyright.html" />
    <link rel="next" title="Bluetooth Notification" href="notification.html" />
    <link rel="prev" title="Watchdog" href="drivers/watchdog.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: white" >
          

          
            <a href="index.html" class="icon icon-home"> open source watch
          

          
          </a>

          
            
            
              <div class="version">
                beta
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="copyright.html">Copyright</a></li>
<li class="toctree-l1"><a class="reference internal" href="content.html">Zephyr  smartwatch framework</a></li>
<li class="toctree-l1"><a class="reference internal" href="idea.html">The idea behind the framework</a></li>
<li class="toctree-l1"><a class="reference internal" href="installation.html">Install zephyr</a></li>
<li class="toctree-l1"><a class="reference internal" href="out-of-tree.html">Out of tree</a></li>
<li class="toctree-l1"><a class="reference internal" href="display.html">display</a></li>
<li class="toctree-l1"><a class="reference internal" href="basicapplications.html">Starting with some basic applications</a></li>
<li class="toctree-l1"><a class="reference internal" href="lvgl.html">LittlevGL Basic Sample</a></li>
<li class="toctree-l1"><a class="reference internal" href="RTC.html">Real Time Clock</a></li>
<li class="toctree-l1"><a class="reference internal" href="current-time.html">Current Time Service</a></li>
<li class="toctree-l1"><a class="reference internal" href="drivers/drivers.html">Drivers</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">bluetooth (BLE)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#a-word-on-bluetooth-serial-communication">A word on bluetooth-serial communication</a></li>
<li class="toctree-l2"><a class="reference internal" href="#eddy-stone">Eddy Stone</a></li>
<li class="toctree-l2"><a class="reference internal" href="#using-the-created-bluetooth-sample">Using the created bluetooth sample:</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#the-no-bluetooth-no-watch-approach-nrf52-bsim">the no-bluetooth, no-watch approach : nrf52_bsim</a></li>
<li class="toctree-l3"><a class="reference internal" href="#the-no-watch-approach-simulation-on-a-laptop">the no-watch approach : simulation on a laptop</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#bluez">Bluez</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#using-bluez-to-write-something-to-the-device">using bluez to write something to the device</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#using-python-to-read-out-bluetoothservices">using Python to read out bluetoothservices</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="notification.html">Bluetooth Notification</a></li>
<li class="toctree-l1"><a class="reference internal" href="fota/fota.html">Firmware Over The Air (FOTA)</a></li>
<li class="toctree-l1"><a class="reference internal" href="samples/index.html">Samples</a></li>
<li class="toctree-l1"><a class="reference internal" href="menuconfig.html">Menuconfig</a></li>
<li class="toctree-l1"><a class="reference internal" href="debugging/debugging.html">Debugging</a></li>
<li class="toctree-l1"><a class="reference internal" href="hacking/hacking.html">Hacking stuff</a></li>
<li class="toctree-l1"><a class="reference internal" href="behind/behind.html">Behind the scene</a></li>
<li class="toctree-l1"><a class="reference internal" href="about.html">About</a></li>
<li class="toctree-l1"><a class="reference internal" href="author.html">Author</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">open source watch</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html">Docs</a> &raquo;</li>
        
      <li>bluetooth (BLE)</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/bluetooth.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="bluetooth-ble">
<h1>bluetooth (BLE)<a class="headerlink" href="#bluetooth-ble" title="Permalink to this headline">¶</a></h1>
<p>Bluetooth is a very nice feature, it lets you exchange data wireless and (!) update firmware wireless.</p>
<p>The PineTime uses a Nordic nrf52832 chip, which has BLE functionality build into it.</p>
<p>To test, you can compile a standard application : Eddy Stone.</p>
<div class="section" id="a-word-on-bluetooth-serial-communication">
<h2>A word on bluetooth-serial communication<a class="headerlink" href="#a-word-on-bluetooth-serial-communication" title="Permalink to this headline">¶</a></h2>
<p>Smartwatch manufacturers usually supply you with a smartwatch app.
This app can communicate trough bluetooth, and get/send data to the watch.</p>
<p>Unfortunately this is not a standard Zephyr feature!</p>
<p>You could use nRF Connect SDK (often referred as NCS),it is Nordic Semiconductor SDK based on zephyr. It has additional features that could be useful for pinetime, namely bluetooth modules and bluetooth services. Important to mention that even though, NCS forks zephyr it is kept close to it and it is regularly updated to latest zephyr (typically every 2-3 weeks).</p>
<p>NCS has no impact on build framework and overall user experience. The only downside I can think of is that NCS is based on older version of zephyr (~2 weeks behind).</p>
<p>The main reason why i’m bringing it up is bluetooth shell. Zephyr has very nice shell module with multiple transports (UART, RTT). NCS extends it with bluetooth transport (using Nordic Uart Service) and host tool for using it. There is an application for linux from which you can use shell over bluetooth, get logs, etc.. It is really cool and can be very useful when playing with pinetime where you can get logs or control/tune things with only wireless connection to your PC. Here is a demonstration of bluetooth console used in one of nordic reference kits: <a class="reference external" href="https://www.youtube.com/watch?v=3KzTfr6S4pg&amp;t=">https://www.youtube.com/watch?v=3KzTfr6S4pg&amp;t=</a> . It’s based on nRF5 SDK (not zephyr) but bluetooth shell (and PC tool) was taken from there.</p>
<p>The Nordic UART Service (NUS) shell transport sample demonstrates how to use the receive shell commands from a remote device.</p>
<p>NCS is using BSD-5-Clause-Nordic license (<a class="reference external" href="https://github.com/NordicPlayground/fw-nrfconnect-nrf/blob/master/LICENSE">https://github.com/NordicPlayground/fw-nrfconnect-nrf/blob/master/LICENSE</a>)</p>
<p>Zephyr RTOS and the samples I use/create use the Apache License 2.0.
A permissive license whose main conditions require preservation of copyright and license notices. Contributors provide an express grant of patent rights. Licensed works, modifications, and larger works may be distributed under different terms and without source code.</p>
</div>
<div class="section" id="eddy-stone">
<h2>Eddy Stone<a class="headerlink" href="#eddy-stone" title="Permalink to this headline">¶</a></h2>
<blockquote>
<div><p>see:   <span class="xref std std-ref">bluetooth-eddystone-sample</span></p>
</div></blockquote>
<p><strong>Note:</strong>  compile the provided example, so a build directory gets created</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> west build -p -b pinetime_devkit0 samples/bluetooth/eddystone
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">this</span> <span class="pre">builds</span> <span class="pre">an</span> <span class="pre">image,</span> <span class="pre">which</span> <span class="pre">can</span> <span class="pre">be</span> <span class="pre">found</span> <span class="pre">under</span> <span class="pre">the</span> <span class="pre">build</span> <span class="pre">directory</span></code></p>
</div>
<div class="section" id="using-the-created-bluetooth-sample">
<h2>Using the created bluetooth sample:<a class="headerlink" href="#using-the-created-bluetooth-sample" title="Permalink to this headline">¶</a></h2>
<p>I use linux with a bluetoothadapter 4.0.
You need to install bluez.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">#</span>bluetoothctl
<span class="gp">[bluetooth]#</span>scan on
</pre></div>
</div>
<p>And your Eddy Stone should be visible.</p>
<p>It is the peripheral which advertises, and the central that reads the data.</p>
<p>A sample which advertises a heartrate :</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">west</span> <span class="n">build</span> <span class="o">-</span><span class="n">p</span> <span class="o">-</span><span class="n">b</span> <span class="n">pinetime_devkit0</span> <span class="n">samples</span><span class="o">/</span><span class="n">bluetooth</span><span class="o">/</span><span class="n">peripheral_hr</span>
</pre></div>
</div>
<p>you could use your smartphone or bluez on linux to read out the heartrate.</p>
<p>Or if you have another watch, the central will connect to the peripheral and read out the heartrate.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">west</span> <span class="n">build</span> <span class="o">-</span><span class="n">p</span> <span class="o">-</span><span class="n">b</span> <span class="n">pinetime_devkit0</span> <span class="n">samples</span><span class="o">/</span><span class="n">bluetooth</span><span class="o">/</span><span class="n">central_hr</span>
</pre></div>
</div>
<div class="section" id="the-no-bluetooth-no-watch-approach-nrf52-bsim">
<h3>the no-bluetooth, no-watch approach : nrf52_bsim<a class="headerlink" href="#the-no-bluetooth-no-watch-approach-nrf52-bsim" title="Permalink to this headline">¶</a></h3>
<p>Suppose you have no watch, no development board, nor any bluetooth dongles?
You can still test your bluetooth enabled application.
<a class="reference external" href="https://docs.zephyrproject.org/latest/boards/posix/nrf52_bsim/doc/index.html">https://docs.zephyrproject.org/latest/boards/posix/nrf52_bsim/doc/index.html</a></p>
<p>We follow the same logic, but this time we specify the nrf52_bsim board.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>west build -p -b nrf52_bsim samples/bluetooth/peripheral_hr
west build -p -b nrf52_bsim samples/bluetooth/central_hr
cp build/zephyr/zephyr.exe  ${BSIM_OUT_PATH}/bin/bs_nrf52_bsim_samples_bluetooth_central_hr
</pre></div>
</div>
<p>Once compiled you can execute both the peripheral and central firmware, and(!) you have to start the bluetooth simulation.
By starting each application in its own terminal, you can keep an eye on the output.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>${BSIM_OUT_PATH}/bin/bs_nrf52_bsim_samples_bluetooth_central_hr -s=trial_sim -d=1

 zephyr/build/zephyr/zephyr.exe -s=trial_sim -d=0
 ${BSIM_OUT_PATH}/bin/bs_2G4_phy_v1 -s=trial_sim -D=2 -sim_length=10e6
</pre></div>
</div>
</div>
<div class="section" id="the-no-watch-approach-simulation-on-a-laptop">
<h3>the no-watch approach : simulation on a laptop<a class="headerlink" href="#the-no-watch-approach-simulation-on-a-laptop" title="Permalink to this headline">¶</a></h3>
<p>how to activate bluetooth?</p>
<p>VBOX running ubuntu (first deactivate driver in windows)
(CTRL home – select usb – (intel in my case)) – this lets you select the integrated bluetooth module of your laptop</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">hciconfig</span> <span class="n">hci0</span> <span class="n">down</span>

<span class="n">west</span> <span class="n">build</span> <span class="o">-</span><span class="n">p</span> <span class="o">-</span><span class="n">b</span> <span class="n">native_posix_64</span> <span class="n">samples</span><span class="o">/</span><span class="n">bluetooth</span><span class="o">/</span><span class="n">peripheral_hr</span>
<span class="o">./</span><span class="n">build</span><span class="o">/</span><span class="n">zephyr</span><span class="o">/</span><span class="n">zephyr</span><span class="o">.</span><span class="n">exe</span> <span class="o">--</span><span class="n">bt</span><span class="o">-</span><span class="n">dev</span><span class="o">=</span><span class="n">hci0</span>
</pre></div>
</div>
<p>Now you can connect your smartphone to the posix_64 bluetooth device!</p>
<p>Or, with a second bluetooth interface (eg dongle)
.. code-block:: console</p>
<blockquote>
<div><p>bluetoothctl
[bluetooth]# devices
Device C6:78:40:29:EC:31 Zephyr Heartrate Sensor
Device C9:16:85:ED:B6:4E DS-D6 b64e
Device C8:B7:89:A9:B0:C9 Espruino-107 b0c9
Device 00:1A:7D:DA:71:0B posix_64</p>
<p>[bluetooth]# info 00:1A:7D:DA:71:0B
Device 00:1A:7D:DA:71:0B (public)
Name: posix_64
Alias: posix_64
Paired: no
Trusted: no
Blocked: no
Connected: no
LegacyPairing: no
UUID: Device Information        (0000180a-0000-1000-8000-00805f9b34fb)
UUID: Current Time Service      (00001805-0000-1000-8000-00805f9b34fb)</p>
</div></blockquote>
<p>If you have a smartphone, you can download the nrf utilities app from nordic.</p>
</div>
</div>
<div class="section" id="bluez">
<h2>Bluez<a class="headerlink" href="#bluez" title="Permalink to this headline">¶</a></h2>
<p>With Bluez on linux you can investigate the bluetoothservices,  using bluetoothctl:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">#</span>bluetoothctl
<span class="gp">[bluetooth]#</span>scan on


<span class="go">[NEW] Device 60:7C:9E:92:50:C1 Zephyr Peripheral Sample Long</span>
<span class="go">once you see your device</span>
<span class="gp">[blueooth]#</span>connect <span class="m">60</span>:7C:9E:92:50:C1 <span class="o">(</span>the device mac address as displayed<span class="o">)</span>

<span class="go">then you can already see the services</span>
</pre></div>
</div>
<div class="section" id="using-bluez-to-write-something-to-the-device">
<h3>using bluez to write something to the device<a class="headerlink" href="#using-bluez-to-write-something-to-the-device" title="Permalink to this headline">¶</a></h3>
<dl class="simple">
<dt>Characteristic</dt><dd><p>/org/bluez/hci0/dev_74_71_4B_D5_18_21/service001f/char0023
00002a38-0000-1000-8000-00805f9b34fb
Body Sensor Location</p>
</dd>
</dl>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">[dsd6]#</span> <span class="k">select</span>-attribute /org/bluez/hci0/dev_74_71_4B_D5_18_21/service001f/char0023
<span class="go">write &lt;data=0x1&gt;</span>
</pre></div>
</div>
<p>same thing with the app from nordic, you could try to connect and display value of e.g. heart rate</p>
</div>
</div>
<div class="section" id="using-python-to-read-out-bluetoothservices">
<h2>using Python to read out bluetoothservices<a class="headerlink" href="#using-python-to-read-out-bluetoothservices" title="Permalink to this headline">¶</a></h2>
<p>In this repo you will find a python script : readbat.py
In order to use it you need bluez on linux and the python <cite>bluepy</cite> module.</p>
<p>It can be used in conjunction with the peripheral bluetooth demo.
It just reads out the battery level, and prints it.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">binascii</span>
<span class="kn">from</span> <span class="nn">bluepy.btle</span> <span class="kn">import</span> <span class="n">UUID</span><span class="p">,</span> <span class="n">Peripheral</span>

<span class="n">temp_uuid</span> <span class="o">=</span> <span class="n">UUID</span><span class="p">(</span><span class="mh">0x2A19</span><span class="p">)</span>

<span class="n">p</span> <span class="o">=</span> <span class="n">Peripheral</span><span class="p">(</span><span class="s2">&quot;60:7C:9E:92:50:C1&quot;</span><span class="p">,</span> <span class="s2">&quot;random&quot;</span><span class="p">)</span>

<span class="k">try</span><span class="p">:</span>
   <span class="n">ch</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">getCharacteristics</span><span class="p">(</span><span class="n">uuid</span><span class="o">=</span><span class="n">temp_uuid</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
   <span class="nb">print</span> <span class="n">binascii</span><span class="o">.</span><span class="n">b2a_hex</span><span class="p">(</span><span class="n">ch</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
<span class="k">finally</span><span class="p">:</span>
    <span class="n">p</span><span class="o">.</span><span class="n">disconnect</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="notification.html" class="btn btn-neutral float-right" title="Bluetooth Notification" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="drivers/watchdog.html" class="btn btn-neutral float-left" title="Watchdog" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; <a href="copyright.html">Copyright</a> 2020, jj

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>